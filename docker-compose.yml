services:
  neko-image-sync:
    image: docker:cli
    pull_policy: always
    restart: "no"
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
    command:
      - /bin/sh
      - -lc
      - |
        set -e
        for img in ghcr.io/m1k1o/neko/firefox:latest ghcr.io/m1k1o/neko/chromium:latest; do
          ok=0
          for i in 1 2 3; do
            echo "pull attempt $${i} for $${img}"
            if docker pull "$${img}"; then
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$${ok}" -ne 1 ]; then
            echo "failed to pull $${img} after retries"
            exit 1
          fi
        done
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  neko-rooms:
    image: m1k1o/neko-rooms:latest
    restart: unless-stopped
    depends_on:
      neko-image-sync:
        condition: service_completed_successfully
    environment:
      TZ: UTC
      NEKO_ROOMS_MUX: "true"
      NEKO_ROOMS_EPR: 59000-59049
      NEKO_ROOMS_NAT1TO1: 127.0.0.1
      NEKO_ROOMS_INSTANCE_URL: http://127.0.0.1:8080/
      NEKO_ROOMS_INSTANCE_NETWORK: neko-rooms-net
      NEKO_ROOMS_TRAEFIK_ENABLED: "false"
      NEKO_ROOMS_PATH_PREFIX: /room/
      NEKO_ROOMS_STORAGE_ENABLED: "true"
      NEKO_ROOMS_STORAGE_INTERNAL: /data
      NEKO_ROOMS_STORAGE_EXTERNAL: /opt/neko-rooms/data
      NEKO_ROOMS_NEKO_IMAGES: |
        ghcr.io/m1k1o/neko/firefox:latest
        ghcr.io/m1k1o/neko/chromium:latest
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/neko-rooms/data:/opt/neko-rooms/data
    networks:
      - neko-rooms-net

  neko-demo:
    profiles: ["demo"]
    image: ghcr.io/m1k1o/neko/firefox:latest
    restart: unless-stopped
    shm_size: 2gb
    environment:
      NEKO_DESKTOP_SCREEN: 1920x1080@30
      NEKO_MEMBER_MULTIUSER_USER_PASSWORD: neko
      NEKO_MEMBER_MULTIUSER_ADMIN_PASSWORD: admin
      NEKO_WEBRTC_EPR: 52000-52100
      NEKO_WEBRTC_ICELITE: "1"
    ports:
      - "8090:8080"
      - "52000-52100:52000-52100/udp"
    networks:
      - neko-rooms-net

networks:
  neko-rooms-net:
    name: neko-rooms-net
    driver: bridge
    attachable: true
