import{m as l,C as a,h as f,T as c,d as w,M as y,a as b}from"./index.8ebcd61e.js";function g(e){let t=new DOMParser().parseFromString(e,"text/html");return t.querySelectorAll('a[href*="://"]').forEach(n=>{n.setAttribute("target","_blank")}),t.documentElement.outerHTML}window.Alpine=l;l.store("challenge",{data:{view:""}});l.data("Hint",()=>({id:null,html:null,async showHint(e){if(e.target.open){let s=await a.pages.challenge.loadHint(this.id);if(s.errors){e.target.open=!1,a._functions.challenge.displayUnlockError(s);return}let t=s.data;if(t.content)this.html=g(t.html);else if(await a.pages.challenge.displayUnlock(this.id)){let n=await a.pages.challenge.loadUnlock(this.id);if(n.success){let h=(await a.pages.challenge.loadHint(this.id)).data;this.html=g(h.html)}else e.target.open=!1,a._functions.challenge.displayUnlockError(n)}else e.target.open=!1}}}));l.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],submissions:[],solution:null,response:null,share_url:null,max_attempts:0,attempts:0,ratingValue:0,selectedRating:0,ratingReview:"",ratingSubmitted:!1,connecting:!1,autocheckTimer:null,autocheckInFlight:!1,access:{type:"",url:"",directUrl:"",embeddedUrl:"",embedTerminal:!1,host:"",port:"",username:"",password:"",instructions:"",command:"",raw:"",autogradeEnabled:!1,hasData:!1},async init(){f()},initConnectionInfo(e){const s={type:"",url:"",directUrl:"",embeddedUrl:"",embedTerminal:!1,host:"",port:"",username:"",password:"",instructions:"",command:"",raw:"",autogradeEnabled:!1,hasData:!1};if(this.stopAutoCheck(),!e){this.access=s;return}let t=null,i="";if(typeof e=="object")t=e;else if(typeof e=="string"){if(i=e.trim(),!i){this.access=s;return}try{t=JSON.parse(i)}catch{}}else{this.access=s;return}if(t&&(t.schema==="ctfd-access-v1"||t.type||t.url||t.host)){const n=(t.type||"").toLowerCase(),o=t.autograde||{},h=Object.prototype.hasOwnProperty.call(t,"autograde"),r=(t.host||"").trim(),d=(t.port||"").toString().trim(),u=(t.username||"").trim();let m="";if(n==="ssh"||n==="terminal"&&r){const p=u?`${u}@${r}`:r;m=d?`ssh ${p} -p ${d}`:`ssh ${p}`}this.access={type:n,url:(t.url||"").trim(),directUrl:"",embeddedUrl:"",embedTerminal:!1,host:r,port:d,username:u,password:(t.password||"").trim(),instructions:(t.instructions||"").trim(),command:m,autogradeEnabled:h?Boolean(o.enabled):n==="terminal",raw:"",hasData:!0};return}if(/^https?:\/\//i.test(i)){this.access={...s,type:"url",url:i,directUrl:i,hasData:!0};return}this.access={...s,type:"plain",raw:i,hasData:!0}},async activateConnection(){if(!(!this.id||!this.access.hasData||this.connecting)){this.connecting=!0;try{const s=await(await a.fetch(`/api/v1/challenges/${this.id}/connect`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json"}})).json();if(!s.success){const i=s.errors||{},n=Object.keys(i)[0],o=n&&i[n]&&i[n][0]||"Unable to activate challenge connection";alert(o);return}const t=s.data||{};t.url?(this.access.url=t.url,this.access.directUrl=t.url,this.access.type==="terminal"?(this.access.embeddedUrl=t.url,this.access.embedTerminal=!0):window.open(t.url,"_blank","noopener")):alert("Challenge launched but no terminal URL is configured for this challenge."),t.host&&(this.access.host=t.host),t.port&&(this.access.port=t.port),this.startAutoCheck()}catch{alert("Unable to activate challenge connection")}finally{this.connecting=!1}}},closeEmbeddedTerminal(){this.access.embedTerminal=!1,this.access.embeddedUrl="",this.stopAutoCheck()},stopAutoCheck(){this.autocheckTimer&&(window.clearInterval(this.autocheckTimer),this.autocheckTimer=null),this.autocheckInFlight=!1},startAutoCheck(){this.stopAutoCheck(),!(this.access.type!=="terminal"||!this.access.autogradeEnabled||!this.id)&&(this.autocheckTimer=window.setInterval(()=>{this.runAutoCheck()},6e3),this.runAutoCheck())},async runAutoCheck(){if(!(this.autocheckInFlight||!this.id)){this.autocheckInFlight=!0;try{const s=await(await a.fetch(`/api/v1/challenges/${this.id}/autocheck`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json"}})).json();if(!s.success||!s.data)return;const t=s.data.status;(t==="correct"||t==="already_solved")&&(this.response={data:{status:t,message:s.data.message||(t==="correct"?"Auto-validated from terminal activity.":"Already solved")}},this.submission="",this.$dispatch("load-challenges"),this.stopAutoCheck())}catch{}finally{this.autocheckInFlight=!1}}},getStyles(){let e={"modal-dialog":!0};this.access.embedTerminal&&(e["modal-xl"]=!0);try{switch(a.config.themeSettings.challenge_window_size){case"sm":e["modal-sm"]=!0;break;case"lg":e["modal-lg"]=!0;break;case"xl":e["modal-xl"]=!0;break;default:break}}catch(s){console.log("Error processing challenge_window_size"),console.log(s)}return e},async init(){f()},async showChallenge(){new c(this.$el).show()},async showSolves(){this.solves=await a.pages.challenge.loadSolves(this.id),this.solves.forEach(e=>(e.date=w(e.date).format("MMMM Do, h:mm:ss A"),e)),new c(this.$el).show()},async showSubmissions(){let e=await a.pages.users.userSubmissions("me",this.id);this.submissions=e.data,this.submissions.forEach(s=>(s.date=w(s.date).format("MMMM Do, h:mm:ss A"),s)),new c(this.$el).show()},getSolutionId(){return l.store("challenge").data.solution_id},getSolutionState(){return l.store("challenge").data.solution_state},setSolutionId(e){l.store("challenge").data.solution_id=e},async showSolution(){let e=this.getSolutionId();a._functions.challenge.displaySolution=s=>{this.solution=s.html,new c(this.$el).show()},await a.pages.challenge.displaySolution(e)},getNextId(){return l.store("challenge").data.next_id},async nextChallenge(){let e=y.getOrCreateInstance("[x-ref='challengeWindow']");e._element.addEventListener("hidden.bs.modal",s=>{l.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),e.hide()},async getShareUrl(){let e={type:"solve",challenge_id:this.id};const i=(await(await a.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(e)})).json()).data.url;this.share_url=i},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let e=b.getOrCreateInstance(this.$el);e.enable(),e.show(),setTimeout(()=>{e.hide(),e.disable()},2e3)},async submitChallenge(){this.response=await a.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){if(this.response.data.status==="correct"&&(this.submission=""),this.getSolutionId()==null&&a.pages.challenge.checkSolution(this.getSolutionState(),l.store("challenge").data,this.response.data.status)){let e=await a.pages.challenge.getSolution(this.id);this.setSolutionId(e.id)}this.max_attempts>0&&this.response.data.status!="already_solved"&&this.response.data.status!="ratelimited"&&(this.attempts+=1),this.$dispatch("load-challenges")},async submitRating(){(await a.pages.challenge.submitRating(this.id,this.selectedRating,this.ratingReview)).value?(this.ratingValue=this.selectedRating,this.ratingSubmitted=!0):alert("Error submitting rating")}}));l.data("ChallengeBoard",()=>({loaded:!1,challenges:[],challenge:null,async init(){if(this.challenges=await a.pages.challenges.getChallenges(),this.loaded=!0,window.location.hash){let e=decodeURIComponent(window.location.hash.substring(1)),s=e.lastIndexOf("-");if(s>=0){let i=[e.slice(0,s),e.slice(s+1)][1];await this.loadChallenge(i)}}},getCategories(){const e=[];this.challenges.forEach(s=>{const{category:t}=s;e.includes(t)||e.push(t)});try{const s=a.config.themeSettings.challenge_category_order;if(s){const t=new Function(`return (${s})`);e.sort(t())}}catch(s){console.log("Error running challenge_category_order function"),console.log(s)}return e},getChallenges(e){let s=this.challenges;e!==null&&(s=this.challenges.filter(t=>t.category===e));try{const t=a.config.themeSettings.challenge_order;if(t){const i=new Function(`return (${t})`);s.sort(i())}}catch(t){console.log("Error running challenge_order function"),console.log(t)}return s},async loadChallenges(){this.challenges=await a.pages.challenges.getChallenges()},async loadChallenge(e){await a.pages.challenge.displayChallenge(e,s=>{s.data.view=g(s.data.view),l.store("challenge").data=s.data,l.nextTick(()=>{let t=y.getOrCreateInstance("[x-ref='challengeWindow']");t._element.addEventListener("hidden.bs.modal",i=>{history.replaceState(null,null," ")},{once:!0}),t.show(),history.replaceState(null,null,`#${s.data.name}-${e}`)})})}}));l.start();
