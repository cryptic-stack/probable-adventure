import{m as l,C as n,h as p,T as c,d as m,M as f,a as w}from"./index.8ebcd61e.js";function d(e){let s=new DOMParser().parseFromString(e,"text/html");return s.querySelectorAll('a[href*="://"]').forEach(i=>{i.setAttribute("target","_blank")}),s.documentElement.outerHTML}window.Alpine=l;l.store("challenge",{data:{view:""}});l.data("Hint",()=>({id:null,html:null,async showHint(e){if(e.target.open){let t=await n.pages.challenge.loadHint(this.id);if(t.errors){e.target.open=!1,n._functions.challenge.displayUnlockError(t);return}let s=t.data;if(s.content)this.html=d(s.html);else if(await n.pages.challenge.displayUnlock(this.id)){let i=await n.pages.challenge.loadUnlock(this.id);if(i.success){let r=(await n.pages.challenge.loadHint(this.id)).data;this.html=d(r.html)}else e.target.open=!1,n._functions.challenge.displayUnlockError(i)}else e.target.open=!1}}}));l.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],submissions:[],solution:null,response:null,share_url:null,max_attempts:0,attempts:0,ratingValue:0,selectedRating:0,ratingReview:"",ratingSubmitted:!1,connecting:!1,access:{type:"",url:"",host:"",port:"",username:"",password:"",instructions:"",command:"",raw:"",hasData:!1},async init(){p()},initConnectionInfo(e){const t={type:"",url:"",host:"",port:"",username:"",password:"",instructions:"",command:"",raw:"",hasData:!1};if(!e){this.access=t;return}let s=null,a="";if(typeof e=="object")s=e;else if(typeof e=="string"){if(a=e.trim(),!a){this.access=t;return}try{s=JSON.parse(a)}catch{}}else{this.access=t;return}if(s&&(s.schema==="ctfd-access-v1"||s.type||s.url||s.host)){const i=(s.type||"").toLowerCase(),o=(s.host||"").trim(),r=(s.port||"").toString().trim(),h=(s.username||"").trim();let g="";if(i==="ssh"||i==="terminal"&&o){const u=h?`${h}@${o}`:o;g=r?`ssh ${u} -p ${r}`:`ssh ${u}`}this.access={type:i,url:(s.url||"").trim(),host:o,port:r,username:h,password:(s.password||"").trim(),instructions:(s.instructions||"").trim(),command:g,raw:"",hasData:!0};return}if(/^https?:\/\//i.test(a)){this.access={...t,type:"url",url:a,hasData:!0};return}this.access={...t,type:"plain",raw:a,hasData:!0}},async activateConnection(){if(!this.id||!this.access.hasData||this.connecting)return;let e=null;(this.access.type==="terminal"||this.access.type==="rdp"||this.access.type==="url")&&(e=window.open("","_blank","noopener")),this.connecting=!0;try{const s=await(await n.fetch(`/api/v1/challenges/${this.id}/connect`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json"}})).json();if(!s.success){const i=s.errors||{},o=Object.keys(i)[0],r=o&&i[o]&&i[o][0]||"Unable to activate challenge connection";alert(r);return}const a=s.data||{};a.url?(this.access.url=a.url,e?e.location=a.url:window.open(a.url,"_blank","noopener")):e&&(e.close(),alert("Challenge launched but no terminal URL is configured for this challenge.")),a.host&&(this.access.host=a.host),a.port&&(this.access.port=a.port)}catch{e&&e.close(),alert("Unable to activate challenge connection")}finally{this.connecting=!1}},getStyles(){let e={"modal-dialog":!0};try{switch(n.config.themeSettings.challenge_window_size){case"sm":e["modal-sm"]=!0;break;case"lg":e["modal-lg"]=!0;break;case"xl":e["modal-xl"]=!0;break;default:break}}catch(t){console.log("Error processing challenge_window_size"),console.log(t)}return e},async init(){p()},async showChallenge(){new c(this.$el).show()},async showSolves(){this.solves=await n.pages.challenge.loadSolves(this.id),this.solves.forEach(e=>(e.date=m(e.date).format("MMMM Do, h:mm:ss A"),e)),new c(this.$el).show()},async showSubmissions(){let e=await n.pages.users.userSubmissions("me",this.id);this.submissions=e.data,this.submissions.forEach(t=>(t.date=m(t.date).format("MMMM Do, h:mm:ss A"),t)),new c(this.$el).show()},getSolutionId(){return l.store("challenge").data.solution_id},getSolutionState(){return l.store("challenge").data.solution_state},setSolutionId(e){l.store("challenge").data.solution_id=e},async showSolution(){let e=this.getSolutionId();n._functions.challenge.displaySolution=t=>{this.solution=t.html,new c(this.$el).show()},await n.pages.challenge.displaySolution(e)},getNextId(){return l.store("challenge").data.next_id},async nextChallenge(){let e=f.getOrCreateInstance("[x-ref='challengeWindow']");e._element.addEventListener("hidden.bs.modal",t=>{l.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),e.hide()},async getShareUrl(){let e={type:"solve",challenge_id:this.id};const a=(await(await n.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(e)})).json()).data.url;this.share_url=a},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let e=w.getOrCreateInstance(this.$el);e.enable(),e.show(),setTimeout(()=>{e.hide(),e.disable()},2e3)},async submitChallenge(){this.response=await n.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){if(this.response.data.status==="correct"&&(this.submission=""),this.getSolutionId()==null&&n.pages.challenge.checkSolution(this.getSolutionState(),l.store("challenge").data,this.response.data.status)){let e=await n.pages.challenge.getSolution(this.id);this.setSolutionId(e.id)}this.max_attempts>0&&this.response.data.status!="already_solved"&&this.response.data.status!="ratelimited"&&(this.attempts+=1),this.$dispatch("load-challenges")},async submitRating(){(await n.pages.challenge.submitRating(this.id,this.selectedRating,this.ratingReview)).value?(this.ratingValue=this.selectedRating,this.ratingSubmitted=!0):alert("Error submitting rating")}}));l.data("ChallengeBoard",()=>({loaded:!1,challenges:[],challenge:null,async init(){if(this.challenges=await n.pages.challenges.getChallenges(),this.loaded=!0,window.location.hash){let e=decodeURIComponent(window.location.hash.substring(1)),t=e.lastIndexOf("-");if(t>=0){let a=[e.slice(0,t),e.slice(t+1)][1];await this.loadChallenge(a)}}},getCategories(){const e=[];this.challenges.forEach(t=>{const{category:s}=t;e.includes(s)||e.push(s)});try{const t=n.config.themeSettings.challenge_category_order;if(t){const s=new Function(`return (${t})`);e.sort(s())}}catch(t){console.log("Error running challenge_category_order function"),console.log(t)}return e},getChallenges(e){let t=this.challenges;e!==null&&(t=this.challenges.filter(s=>s.category===e));try{const s=n.config.themeSettings.challenge_order;if(s){const a=new Function(`return (${s})`);t.sort(a())}}catch(s){console.log("Error running challenge_order function"),console.log(s)}return t},async loadChallenges(){this.challenges=await n.pages.challenges.getChallenges()},async loadChallenge(e){await n.pages.challenge.displayChallenge(e,t=>{t.data.view=d(t.data.view),l.store("challenge").data=t.data,l.nextTick(()=>{let s=f.getOrCreateInstance("[x-ref='challengeWindow']");s._element.addEventListener("hidden.bs.modal",a=>{history.replaceState(null,null," ")},{once:!0}),s.show(),history.replaceState(null,null,`#${t.data.name}-${e}`)})})}}));l.start();
